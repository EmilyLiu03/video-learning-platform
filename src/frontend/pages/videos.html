<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è§†é¢‘ - ä¸ƒå¤©é€Ÿæˆå‰ç«¯é­”æ³•å¸ˆ</title>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/videos.css">
    <!-- ç™»å½•éªŒè¯è„šæœ¬ -->
    <script src="../js/auth-guard.js"></script>
</head>
    <script src="../js/auth-guard.js"></script>
</head>
<body class="magic-bg">
    <!-- æ‚¬æµ®å¯¼èˆªæ  -->
    <nav class="nav-bar">
        <div class="nav-content">
            <div class="nav-left">
                <div class="nav-wizard"></div>
                <span class="nav-title">ä¸ƒå¤©é€Ÿæˆå‰ç«¯é­”æ³•å¸ˆ</span>
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">è¿”å›é¦–é¡µ</a>
                <a href="dashboard.html" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
                <a href="intro.html" class="nav-link">è¯¾ç¨‹ä»‹ç»</a>
                <button class="avatar-button" onclick="window.location.href='dashboard.html'"></button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page-header">
            <h1 class="page-title">æˆ‘çš„è§†é¢‘</h1>
            <p class="page-subtitle">æ¢ç´¢æœ¬åœ°åŒ–å­¦ä¹ çš„é­”æ³•ä¸–ç•Œ</p>
        </div>

        <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
        <div class="user-info" id="user-info" style="display: none;">
            <p>å½“å‰ç”¨æˆ·ï¼š<span id="current-user"></span></p>
        </div>

        <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
        <div class="search-section">
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="æœç´¢æˆ‘çš„è§†é¢‘...">
                <button class="search-btn" onclick="searchVideos()">
                    <span class="search-icon">ğŸ”</span>
                </button>
                <button class="upload-btn" onclick="goToUpload()">
                    <span class="material-icons">add</span>
                    ä¸Šä¼ è§†é¢‘
                </button>
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                <button class="filter-btn" data-filter="recent">æœ€è¿‘ä¸Šä¼ </button>
                <button class="filter-btn" data-filter="favorite">æ”¶è—</button>
            </div>
        </div>

        <!-- è§†é¢‘ç½‘æ ¼ -->
        <div class="videos-grid" id="videos-grid">
            <!-- è§†é¢‘å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨åŠ è½½æ‚¨çš„è§†é¢‘...</p>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div class="empty-state" id="empty-state" style="display: none;">
            <div class="empty-icon">ğŸ“¹</div>
            <h3>æš‚æ— è§†é¢‘</h3>
            <p>æ‚¨è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•è§†é¢‘ï¼Œå¿«å»ä¸Šä¼ æ‚¨çš„ç¬¬ä¸€ä¸ªè§†é¢‘å§ï¼</p>
        </div>

        <!-- æœªç™»å½•çŠ¶æ€ -->
        <div class="not-logged-in" id="not-logged-in" style="display: none;">
            <div class="empty-icon">ğŸ”’</div>
            <h3>è¯·å…ˆç™»å½•</h3>
            <p>æ‚¨éœ€è¦ç™»å½•åæ‰èƒ½æŸ¥çœ‹è‡ªå·±çš„è§†é¢‘</p>
            <button class="magic-button" onclick="window.location.href='login.html'">ç«‹å³ç™»å½•</button>
        </div>

        <!-- è£…é¥°æ˜Ÿæ˜Ÿ -->
        <div class="star star-1 star-decoration"></div>
        <div class="star star-2 star-decoration"></div>
        <div class="star star-3 star-decoration"></div>
        <div class="star star-4 star-decoration"></div>
        <div class="star star-5 star-decoration"></div>
    </div>

    <script>
        let allVideos = [];
        let filteredVideos = [];
        let currentFilter = 'all';
        let currentUser = null;

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶è·å–è§†é¢‘æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            setupEventListeners();
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            // ä»localStorageæˆ–sessionStorageè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            const userInfo = localStorage.getItem('user') || sessionStorage.getItem('user');  // æ”¹ä¸º 'user'
            
            console.log('æ£€æŸ¥ç™»å½•çŠ¶æ€ - ç”¨æˆ·ä¿¡æ¯:', userInfo);
            
            if (userInfo) {
                try {
                    currentUser = JSON.parse(userInfo);
                    console.log('å½“å‰ç”¨æˆ·:', currentUser);
                    document.getElementById('current-user').textContent = currentUser.username || currentUser.id;
                    document.getElementById('user-info').style.display = 'block';
                    loadUserVideos();
                } catch (error) {
                    console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    showNotLoggedIn();
                }
            } else {
                console.log('æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œæ˜¾ç¤ºæœªç™»å½•çŠ¶æ€');
                showNotLoggedIn();  // ç§»é™¤æ¨¡æ‹Ÿç”¨æˆ·é€»è¾‘
            }
        }

        // æ˜¾ç¤ºæœªç™»å½•çŠ¶æ€
        function showNotLoggedIn() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('not-logged-in').style.display = 'flex';
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æœç´¢è¾“å…¥æ¡†
            document.getElementById('search-input').addEventListener('input', function() {
                searchVideos();
            });

            // ç­›é€‰æŒ‰é’®
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    filterVideos();
                });
            });
        }

        // åŠ è½½å½“å‰ç”¨æˆ·çš„è§†é¢‘æ•°æ®
        async function loadUserVideos() {
            if (!currentUser) {
                showNotLoggedIn();
                return;
            }

            try {
                // ç›´æ¥ä»APIè·å–æ‰€æœ‰è§†é¢‘ï¼Œç„¶åè¿‡æ»¤å½“å‰ç”¨æˆ·çš„è§†é¢‘
                const response = await fetch('http://localhost:3001/api/video/list');
                if (response.ok) {
                    const data = await response.json();
                    console.log('è·å–åˆ°çš„æ‰€æœ‰è§†é¢‘:', data.videos);
                    console.log('å½“å‰ç”¨æˆ·ID:', currentUser.id, 'ç”¨æˆ·å:', currentUser.username);
                    
                    // è¿‡æ»¤å‡ºå½“å‰ç”¨æˆ·ä¸Šä¼ çš„è§†é¢‘
                    // å…¼å®¹ä¸åŒçš„ç”¨æˆ·IDå­—æ®µï¼šadminId, userId
                    allVideos = (data.videos || []).filter(video => {
                        const match = video.adminId === currentUser.id || 
                                     video.userId === currentUser.id ||
                                     video.adminId === currentUser.username ||
                                     video.userId === currentUser.username;
                        
                        if (match) {
                            console.log('åŒ¹é…çš„è§†é¢‘:', video.title, 'è§†é¢‘adminId:', video.adminId, 'è§†é¢‘userId:', video.userId);
                        }
                        
                        return match;
                    });
                    
                    console.log('è¿‡æ»¤åçš„ç”¨æˆ·è§†é¢‘æ•°é‡:', allVideos.length);
                } else {
                    console.error('APIå“åº”å¤±è´¥:', response.status, response.statusText);
                    // å¦‚æœAPIä¸å¯ç”¨ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                    allVideos = [];
                }
                filteredVideos = [...allVideos];
                renderVideos();
            } catch (error) {
                console.error('åŠ è½½è§†é¢‘å¤±è´¥:', error);
                allVideos = [];
                filteredVideos = [];
                renderVideos();
            }
        }

        // æ¸²æŸ“è§†é¢‘åˆ—è¡¨
        function renderVideos() {
            const grid = document.getElementById('videos-grid');
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');
            const notLoggedIn = document.getElementById('not-logged-in');

            loading.style.display = 'none';
            notLoggedIn.style.display = 'none';

            if (filteredVideos.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }

            emptyState.style.display = 'none';
            grid.style.display = 'grid';

            grid.innerHTML = filteredVideos.map(video => {
                // å¤„ç†è§†é¢‘å°é¢ï¼šå¦‚æœæ²¡æœ‰å°é¢æˆ–å°é¢ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å°é¢
                const coverUrl = video.coverUrl && video.coverUrl.trim() !== '' 
                    ? video.coverUrl 
                    : generateDefaultCover(video.title);
                
                return `
                    <div class="video-card" onclick="playVideo('${video.id}')">
                        <div class="video-thumbnail">
                            <img src="${coverUrl}" alt="${video.title}" loading="lazy" onerror="this.src='${generateDefaultCover(video.title)}'">
                            <div class="video-duration">${video.duration || 'æœªçŸ¥'}</div>
                            <div class="play-overlay">
                                <div class="play-button">â–¶</div>
                            </div>
                        </div>
                        <div class="video-info">
                            <h3 class="video-title">${video.title}</h3>
                            <p class="video-description">${video.description}</p>
                            <div class="video-meta">
                                <span class="upload-time">${formatDate(video.uploadTime || video.uploadDate)}</span>
                                <span class="video-owner">æˆ‘çš„è§†é¢‘</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æœç´¢è§†é¢‘ï¼ˆä»…åœ¨å½“å‰ç”¨æˆ·çš„è§†é¢‘ä¸­æœç´¢ï¼‰
        function searchVideos() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            filteredVideos = allVideos.filter(video => 
                video.title.toLowerCase().includes(searchTerm) ||
                video.description.toLowerCase().includes(searchTerm)
            );
            renderVideos();
        }

        // ç­›é€‰è§†é¢‘
        function filterVideos() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            switch(currentFilter) {
                case 'recent':
                    filteredVideos = allVideos.filter(video => 
                        (video.title.toLowerCase().includes(searchTerm) ||
                         video.description.toLowerCase().includes(searchTerm))
                    ).sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime));
                    break;
                case 'favorite':
                    // æ¨¡æ‹Ÿæ”¶è—åŠŸèƒ½
                    filteredVideos = allVideos.filter(video => 
                        (video.title.toLowerCase().includes(searchTerm) ||
                         video.description.toLowerCase().includes(searchTerm)) &&
                        Math.random() > 0.5 // éšæœºæ¨¡æ‹Ÿæ”¶è—çŠ¶æ€
                    );
                    break;
                default:
                    filteredVideos = allVideos.filter(video => 
                        video.title.toLowerCase().includes(searchTerm) ||
                        video.description.toLowerCase().includes(searchTerm)
                    );
            }
            renderVideos();
        }

        // æ’­æ”¾è§†é¢‘
        function playVideo(videoId) {
            // è·³è½¬åˆ°è§†é¢‘æ’­æ”¾é¡µé¢
            window.location.href = `player.html?id=${videoId}`;
        }

        // ç”Ÿæˆé»˜è®¤å°é¢
        function generateDefaultCover(title) {
            // åˆ›å»ºä¸€ä¸ªSVGé»˜è®¤å°é¢
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
            const color = colors[Math.abs(hashCode(title)) % colors.length];
            const firstChar = title ? title.charAt(0).toUpperCase() : 'V';
            
            const svg = `
                <svg width="320" height="180" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="grad${Math.abs(hashCode(title))}" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:${color};stop-opacity:1" />
                            <stop offset="100%" style="stop-color:${adjustBrightness(color, -20)};stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grad${Math.abs(hashCode(title))})"/>
                    <circle cx="160" cy="90" r="40" fill="rgba(255,255,255,0.2)"/>
                    <text x="160" y="105" font-family="Arial, sans-serif" font-size="36" font-weight="bold" text-anchor="middle" fill="white">${firstChar}</text>
                    <text x="160" y="140" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="rgba(255,255,255,0.8)">è§†é¢‘å°é¢</text>
                </svg>
            `;
            
            return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
        }
        
        // å­—ç¬¦ä¸²å“ˆå¸Œå‡½æ•°
        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
            }
            return hash;
        }
        
        // è°ƒæ•´é¢œè‰²äº®åº¦
        function adjustBrightness(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥æ—¶é—´';
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 1) {
                return '1å¤©å‰';
            } else if (diffDays < 7) {
                return `${diffDays}å¤©å‰`;
            } else if (diffDays < 30) {
                return `${Math.floor(diffDays / 7)}å‘¨å‰`;
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }

        // è·³è½¬åˆ°ä¸Šä¼ é¡µé¢ï¼ˆplayer.htmlï¼‰
        function goToUpload() {
            window.location.href = 'player.html';
        }

        // æ·»åŠ æ˜Ÿæ˜Ÿé—ªçƒåŠ¨ç”»
        const stars = document.querySelectorAll('.star');
        stars.forEach((star, index) => {
            star.style.animationDelay = `${index * 0.5}s`;
        });
    </script>
</body>
</html>